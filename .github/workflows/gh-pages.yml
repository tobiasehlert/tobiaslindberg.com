name: github pages

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Git clone repo
        run: git clone --recurse-submodules --remote-submodules

      - name: Running some export vars
        env:
          GITHUB_PAGE: tobiasehlert.github.io
          GIT_COMMIT_SHA: $(`git rev-parse --verify HEAD`)
          GIT_COMMIT_SHA_SHORT: $(`git rev-parse --short HEAD`)

      - name: Run sed command to update README
        run: sed -i "s/> Commit SHA: .*/> Commit SHA: \*\*${{GIT_COMMIT_SHA}}\*\* \[\[${{GIT_COMMIT_SHA_SHORT}}\]\(https:\/\/github.com\/tobiasehlert\/tobiaslindberg.com\/commit\/${{GIT_COMMIT_SHA}}\)\]/g" public-${{GITHUB_PAGE}}/README.md

      - name: Setup latest Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: Build with Hugo
        run: hugo --minify --gc --environment githubpages --debug

      - name: Go to public-${{GITHUB_PAGE}}
        run: cd public-$GITHUB_PAGE
        
      - name: Copy of english 404 file to root folder
        run: cp en/404.html .

      - name: Show GIT status
        run: git status

      - name: Add changes to git
        run: git add .

      - name: Show GIT status
        run: git status

      - name: Generating commit changes.
        run: git commit -m "${{GITHUB_PAGE}} | commit ${{GIT_COMMIT_SHA_SHORT}} | generated $(date '+%Y-%m-%d %H:%M:%S')"

      - name: Show GIT status
        run: git status

#      - name: Deploy of content
#        uses: peaceiris/actions-gh-pages@v3
#        with:
#          deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
#          publish_dir: /public-tobiasehlert.github.io
#          publish_branch: gh-actions-testbranch
#          disable_nojekyll: true
#          allow_empty_commit: true
#          user_name: tobiasehlert
#          user_email: tobias.ehlert@gmail.com
